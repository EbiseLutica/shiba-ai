# Chappy - OpenAI APIチャットアプリ仕様書

## 概要
OpenAI APIを用いた、ブラウザで完全動作するキャラクター対話チャットアプリケーション

## ターゲット層
- OpenAI APIを用いてGPTとのキャラクター対話を楽しみたい人
- 比較的高度な知識を持っておりカスタマイズしたい人

## 技術スタック
- **フロントエンド**: Solid.js
- **パッケージマネージャー**: pnpm
- **スタイリング**: TailwindCSS
- **ビルドツール**: Vite
- **データ保存**: LocalStorage
- **動作環境**: ブラウザのみ（完全クライアントサイド）

## 主要機能

### 1. ルーム機能

#### 1.1 ルームの概念
- ルームは「対話するAIの特徴」と「チャット履歴」からなる単位
- 複数のルームを作成・管理可能
- 各ルームは独立したAIキャラクターとチャット履歴を持つ

#### 1.2 AIキャラクター設定
**簡単モード**
- 名前
- 背景情報
- 性格
- 口調
- 話し方の例

**プロモード**
- システムプロンプトの自由入力
- 高度な設定（temperature、max_tokensなど）

#### 1.3 ルーム管理
- ルームの作成・削除・編集
- ルームの複製機能
- 作成順での表示（sort_orderを内部で管理）
- ルーム一覧の表示

### 2. チャット機能

#### 2.1 基本チャット
- テキストメッセージの送受信
- リアルタイム応答表示は不要（完了後に一括表示）
- 最新メッセージが下に表示される形式
- 書き込み欄は画面下部に固定

#### 2.2 メッセージ管理
- メッセージの削除機能
- メッセージの編集機能
- メッセージの再生成機能

### 3. 設定・管理機能

#### 3.1 APIキー管理
- ユーザー自身のOpenAI APIキーを使用
- LocalStorageに保存
- 設定画面での入力・変更

#### 3.2 モデル選択
- 利用可能モデル一覧の取得（API経由）
- 取得不可の場合は以下のプリセット
  - GPT-4.1
  - GPT-4.1-mini
  - GPT-4o
  - GPT-4o-mini
  - GPT-3.5-turbo
- ルーム毎にモデルを設定可能

#### 3.3 高度な設定（プロモード時）
- temperature（0.0 - 2.0）
- max_tokens
- top_p
- frequency_penalty
- presence_penalty

### 4. データ管理

#### 4.1 データ保存
- 全データをLocalStorageに保存
- 保存対象：
  - ルーム情報（AIキャラクター設定含む）
  - チャット履歴
  - アプリ設定
  - APIキー

#### 4.2 容量管理
- LocalStorage容量上限：5MB
- 容量監視機能
- 容量超過前の警告表示
- 容量超過時の新規データ保存制限

#### 4.3 エクスポート/インポート
- **エクスポート対象**：APIキーを除く全データ
- **フォーマット**：JSON
- **インポート機能**：既存データとの統合オプション

### 5. 検索機能

#### 5.1 検索範囲
- ルーム横断検索
- 特定ルーム内検索
- 検索範囲の切り替え可能

#### 5.2 検索対象
- メッセージ内容
- ルーム名

### 6. UI/UX

#### 6.1 レスポンシブデザイン
**デスクトップ版**
- サイドバー（ルーム一覧） + メインエリア（チャット）
- サイドバーの折りたたみ可能

**モバイル版**
- ドロワーメニューまたはタブ切り替え
- タッチ操作に最適化

#### 6.2 テーマ
- ダークモード対応
- ブラウザの設定に自動追従
- 手動切り替えも可能

#### 6.3 UXの詳細
- ローディング状態の表示
- 操作フィードバック
- 直感的なナビゲーション

### 7. エラーハンドリング

#### 7.1 API通信エラー
- ネットワークエラーの検出・表示
- API認証エラーの処理
- レート制限エラーの処理
- 再試行ボタンの提供

#### 7.2 データエラー
- LocalStorage読み書きエラー
- データ破損の検出・復旧
- 容量超過エラー

#### 7.3 ユーザーフィードバック
- エラー内容の分かりやすい表示
- 解決方法の提示
- エラーログの保持（デバッグ用）

### 8. 初期設定・チュートリアル

#### 8.1 初回起動時の判定
- オンボーディングを表示する条件：
  - オンボーディング完了記録がLocalStorageに存在しない
  - または、`onboarding.completed`が`true`でない  
  - または、`onboarding.version`が`"1.0"`でない
- 上記のいずれかに該当する場合、初回起動と判定してチュートリアルを表示

#### 8.2 チュートリアル・設定フロー
初回起動時は、段階的に設定を進めるウィザード形式のUIを表示

**ステップ1: ウェルカム画面**
- タイトル: "Chappyへようこそ！"
- メインメッセージ:
  ```
  このアプリでは、OpenAI APIを用いて、
  あなただけのAIキャラクターとチャットを楽しむことができます。
  
  まず、簡単な設定を行いましょう。
  ```
- アクション: 「次へ」ボタン

**ステップ2: 重要な注意事項**
- タイトル: "ご利用前の重要な注意点"
- 内容:
  ```
  📱 データの保存について
  • このアプリは、サーバーに一切のデータが送信されません
  • ブラウザのデータを削除すると、会話履歴や設定が失われます
  • アプリのデータはエクスポートできるので、定期的にお手元に保存することをお勧めします
  
  🤖 AIの応答について
  • AIの応答は必ずしも正確ではありません
  • 重要な情報は必ず自分で確認してください
  • 特に医学・法律等の専門分野では注意が必要です
  • 本アプリの使用による損害について、開発者は責任を負いません
  ```
- UI要素:
  - チェックボックス: "上記の注意点を理解しました"
  - 「戻る」ボタン、「次へ」ボタン（チェック必須）

**ステップ3: OpenAI APIキー設定**
- タイトル: "OpenAI APIキーの設定"
- 説明:
  ```
  Chappyを使用するには、OpenAI APIキーが必要です。
  APIキーは、OpenAI API Platformから取得できます。
  ```
- UI要素:
  - リンクボタン: "OpenAI API Platformを開く" (新しいタブで開く)
  - テキスト入力: APIキー入力フィールド
  - バリデーション: APIキー形式チェック（sk-で始まる文字列）
  - 「戻る」ボタン、「次へ」ボタン（APIキー入力必須）

**ステップ4: 最初のルーム作成**
- タイトル: "最初のAIキャラクターを作成しましょう"
- 説明:
  ```
  ルームは、AIキャラクターとの会話空間です。
  簡単モードまたはプロモードを選んで、最初のキャラクターを作成してみましょう。
  ```
- UI要素:
  - 既存のルーム作成フォーム（簡単モード/プロモード選択可能）
  - デフォルト値を提供（例: 名前="アシスタント"、簡単モード選択状態）
  - 「戻る」ボタン、「作成して開始」ボタン

**ステップ5: 完了画面**
- タイトル: "設定完了！"
- メッセージ:
  ```
  お疲れ様でした！Chappyの準備が完了しました。
  さっそくAIキャラクターとチャットを始めましょう。
  
  💡 ヒント:
  • サイドバーから新しいルームを作成できます
  • 設定画面から詳細な設定を変更できます
  • データのエクスポート機能をぜひご活用ください
  ```
- アクション: 「チャットを開始」ボタン

#### 8.3 UI/UX設計

**モーダル仕様**
- フルスクリーンオーバーレイ
- ESCキーでの閉じる操作を無効化
- 背景クリックでの閉じる操作を無効化
- ステップ表示（例: "1/5"）
- プログレスバー表示

**レスポンシブ対応**
- デスクトップ: 中央配置、最大幅600px
- モバイル: フルスクリーン表示
- フォントサイズの調整

**アニメーション**
- ステップ間の遷移はスライド効果
- ボタンホバー効果
- 入力フィールドのフォーカス効果

#### 8.4 データ管理

**初期設定完了の記録**
```json
{
  "onboarding_completed": true,
  "onboarding_version": "1.0",
  "completed_at": "timestamp"
}
```

**スキップ機能**
- 各ステップで「スキップ」オプションを提供（APIキー設定除く）
- スキップした項目は後から設定可能
- スキップ時の警告メッセージ表示

#### 8.5 実装優先度
1. 基本的なウィザードUI構築
2. APIキー設定の検証機能
3. 初回ルーム作成の自動化
4. アニメーション・UX改善
5. エラーハンドリング・復旧機能

## データ構造

### ルームデータ
```json
{
  "id": "string",
  "name": "string",
  "sort_order": "number",
  "created_at": "timestamp",
  "updated_at": "timestamp",
  "mode": "simple|pro",
  "simple_config": {
    "name": "string",
    "background": "string",
    "personality": "string",
    "tone": "string",
    "example_speech": "string"
  },
  "pro_config": {
    "system_prompt": "string"
  },
  "model_config": {
    "model": "string",
    "temperature": "number",
    "max_tokens": "number",
    "top_p": "number",
    "frequency_penalty": "number",
    "presence_penalty": "number"
  },
  "messages": [
    {
      "id": "string",
      "role": "user|assistant",
      "content": "string",
      "timestamp": "timestamp"
    }
  ]
}
```

### アプリ設定
```json
{
  "api_key": "string",
  "theme": "auto|light|dark",
  "default_model": "string",
  "ui_preferences": {
    "sidebar_collapsed": "boolean"
  },
  "onboarding": {
    "completed": "boolean",
    "version": "string",
    "completed_at": "timestamp",
    "skipped_steps": ["array of step names"]
  }
}
```

## 開発優先順位

### Phase 1（MVP）
1. 基本的なルーム作成・管理
2. 簡単モードでのAIキャラクター設定
3. 基本チャット機能
4. APIキー設定
5. LocalStorageでのデータ保存

### Phase 2（機能拡張）
1. プロモード実装
2. メッセージ編集・削除・再生成
3. エクスポート/インポート機能
4. 検索機能
5. エラーハンドリング強化

### Phase 3（UX改善）
1. レスポンシブデザイン完成
2. ダークモード対応
3. 容量管理機能
4. パフォーマンス最適化

### Phase 4（ユーザー向けのチュートリアル・初期設定）
1. 初回起動時のチュートリアル
2. 初期設定UI

## 技術的考慮事項

### セキュリティ
- APIキーのLocalStorage保存（暗号化検討）
- XSS対策
- CSP設定

### パフォーマンス
- 大量データ時の仮想スクロール（将来的）
- 画像の遅延読み込み（将来的）
- バンドルサイズの最適化

### 互換性
- モダンブラウザ対応
- LocalStorage対応必須
- ES6+機能の使用

---

この仕様書に基づいて開発を進めることで、ターゲット層のニーズを満たす高機能なチャットアプリケーションを構築できます。
